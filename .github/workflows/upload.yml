name: Upload Instagram Short to YouTube (Twice Daily)

on:
  schedule:
    # Runs at 00:30 and 12:30 UTC daily => 06:00 and 18:00 IST
    - cron: '30 0 * * *'
    - cron: '30 12 * * *'
  workflow_dispatch:

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Write .env (from secrets)
        run: |
          echo "INSTAGRAM_USERNAME=${{ secrets.INSTAGRAM_USERNAME }}" >> .env
          echo "INSTAGRAM_PASSWORD=${{ secrets.INSTAGRAM_PASSWORD }}" >> .env
          echo "YT_CLIENT_ID=${{ secrets.YT_CLIENT_ID }}" >> .env
          echo "YT_CLIENT_SECRET=${{ secrets.YT_CLIENT_SECRET }}" >> .env
          echo "YT_REFRESH_TOKEN=${{ secrets.YT_REFRESH_TOKEN }}" >> .env
          # optional: set UPLOAD_COUNT to 1 so each scheduled run uploads one short
          echo "UPLOAD_COUNT=1" >> .env

      - name: Run uploader
        env:
          # put env here as well so python sees them
          INSTAGRAM_USERNAME: ${{ secrets.INSTAGRAM_USERNAME }}
          INSTAGRAM_PASSWORD: ${{ secrets.INSTAGRAM_PASSWORD }}
          YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
          YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
          YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
          UPLOAD_COUNT: 1
        run: |
          python uploader.py

      - name: Show log file
        if: always()
        run: |
          echo "----- start of upload_log.txt -----"
          cat upload_log.txt || true
          echo "----- end of upload_log.txt -----"

      - name: Commit index and log (if changed)
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.json upload_log.txt || true
          git commit -m "Update index/log from scheduled run" || echo "No changes to commit"
          git push || echo "Push failed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

